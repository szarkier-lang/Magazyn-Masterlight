<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masterlight - System Magazynowy</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary-terracotta: #C4704B;
            --primary-dark: #A85A3A;
            --accent-red: #D84C4C;
            --accent-red-dark: #C23E3E;
            --warm-beige: #F5E6D3;
            --beige-light: #E8D7C3;
            --text-dark: #3E2723;
            --text-light: #6D4C41;
            --border-color: #D7CCC8;
            --success-status: #B8860B;
            --warning-status: #CD853F;
            --error-status: #8B4513;
            --background: #FBF7F2;
            --sidebar-bg: #8B6F47;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background);
            color: var(--text-dark);
            line-height: 1.6;
            margin: 0; padding: 0;
        }

        /* EKRAN LOGOWANIA */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-terracotta) 100%);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .auth-box {
            background: white; padding: 3rem; border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); width: 100%; max-width: 400px; text-align: center;
        }
        .auth-box h2 { color: var(--primary-dark); margin-bottom: 1.5rem; }
        .hidden { display: none !important; }

        /* SIDEBAR */
        .sidebar {
            width: 250px; background: linear-gradient(180deg, var(--sidebar-bg) 0%, #6F5A3A 100%);
            color: #fff; padding: 2rem 0; position: fixed; left: 0; top: 0; height: 100vh;
            overflow-y: auto; box-shadow: 2px 0 15px rgba(0,0,0,0.2);
        }
        .sidebar-logo { padding: 0 1.5rem; margin-bottom: 2rem; border-bottom: 2px solid rgba(255,255,255,0.2); padding-bottom: 1.5rem; }
        .sidebar-logo h2 { font-size: 1.3rem; letter-spacing: 1px; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); }
        .sidebar-nav { list-style: none; padding: 0; }
        .sidebar-nav li { margin: 0; }
        .sidebar-nav a {
            display: flex; align-items: center; gap: 1rem; padding: 1rem 1.5rem;
            color: rgba(255,255,255,0.85); text-decoration: none; transition: all 0.3s ease;
            border-left: 4px solid transparent; cursor: pointer; font-size: 0.95rem;
        }
        .sidebar-nav a:hover { background-color: rgba(255,255,255,0.1); border-left-color: var(--accent-red); color: #fff; }
        .sidebar-nav a.active { background-color: rgba(255,255,255,0.15); border-left-color: var(--accent-red); color: #fff; font-weight: 600; }

        /* MAIN CONTENT */
        .main-content { margin-left: 250px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
        .header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-terracotta) 100%);
            color: #fff; padding: 1.5rem 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border-bottom: 4px solid var(--accent-red);
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-title h1 { font-size: 2rem; margin-bottom: 0.3rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); letter-spacing: 1px; }
        .header-title p { opacity: 0.9; font-size: 0.95rem; }
        .user-badge { background: rgba(0,0,0,0.2); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; border: 1px solid rgba(255,255,255,0.3); text-align: left; display: flex; align-items: center; gap: 15px; }
        
        .content { flex: 1; padding: 2rem; }

        /* TABS */
        .tabs-container { display: flex; gap: 0; border-bottom: 2px solid var(--border-color); margin-bottom: 2rem; }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* STATS & SECTIONS */
        .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card {
            background: #fff; padding: 1.2rem; border-radius: 8px; border-left: 5px solid var(--primary-terracotta);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(196, 112, 75, 0.2); }
        .stat-card h3 { color: var(--primary-terracotta); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; opacity: 0.8; }
        .stat-card .value { font-size: 2rem; font-weight: bold; color: var(--accent-red); }

        .section { background: #fff; margin-bottom: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); overflow: hidden; border-top: 4px solid var(--primary-terracotta); }
        .section-header { background: linear-gradient(135deg, var(--beige-light) 0%, var(--warm-beige) 100%); padding: 1.2rem 1.5rem; border-bottom: 2px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .section-header h2 { color: var(--text-dark); font-size: 1.3rem; margin: 0; }
        .section-header .badge { background: var(--accent-red); color: white; padding: 0.3rem 0.7rem; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .section-content { padding: 1.5rem; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.9rem; }
        table th { background-color: var(--primary-terracotta); color: white; padding: 0.8rem; text-align: left; font-weight: 600; border: 1px solid var(--primary-dark); }
        table td { padding: 0.7rem 0.8rem; border-bottom: 1px solid var(--border-color); color: var(--text-dark); }
        table tbody tr:hover { background-color: var(--warm-beige); }
        table tbody tr:nth-child(even) { background-color: #FAFAF8; }

        .status-badge { display: inline-block; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-align: center; min-width: 70px; }
        .status-ok { background-color: #E8F5E9; color: var(--success-status); border: 1px solid var(--success-status); }
        .status-warning { background-color: #FFF3E0; color: var(--warning-status); border: 1px solid var(--warning-status); }
        .status-error { background-color: #FFEBEE; color: var(--error-status); border: 1px solid var(--error-status); }
        .status-neutral { background-color: #E3F2FD; color: #1565C0; border: 1px solid #1565C0; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; }
        .modal-dialog { background: white; padding: 2rem; border-radius: 8px; max-width: 500px; margin: 100px auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border-top: 4px solid var(--primary-terracotta); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border-color); padding-bottom: 1rem; }
        .close { font-size: 2rem; cursor: pointer; color: var(--text-light); transition: color 0.2s ease; }
        .close:hover { color: var(--accent-red); }
        .modal-body p { margin-bottom: 0.8rem; font-size: 1.1rem; }

        /* BUTTONS & FORMS */
        button { padding: 0.6rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.2rem; }
        .btn-primary { background-color: var(--primary-terracotta); color: white; border: 2px solid var(--primary-terracotta); }
        .btn-primary:hover { background-color: var(--primary-dark); box-shadow: 0 4px 12px rgba(168, 90, 58, 0.3); }
        .btn-secondary { background-color: var(--accent-red); color: white; border: 2px solid var(--accent-red); }
        .btn-secondary:hover { background-color: var(--accent-red-dark); box-shadow: 0 4px 12px rgba(200, 62, 62, 0.3); }
        .btn-small { padding: 0.3rem 0.6rem; font-size: 0.75rem; }

        .form-group { margin-bottom: 1rem; display: flex; flex-direction: column; gap: 0.3rem; }
        .form-group label { font-weight: 600; color: var(--text-dark); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; }
        input[type="text"], input[type="number"], input[type="date"], input[type="email"], input[type="password"] { padding: 0.6rem; border: 2px solid var(--border-color); border-radius: 4px; font-size: 0.9rem; color: var(--text-dark); width: 100%; }
        input:focus { outline: none; border-color: var(--primary-terracotta); box-shadow: 0 0 0 3px rgba(196, 112, 75, 0.1); }

        .editable { cursor: pointer; background-color: rgba(196, 112, 75, 0.05); }
        .editable:hover { background-color: rgba(196, 112, 75, 0.15); }
        .footer { text-align: center; padding: 1.5rem; color: var(--text-light); font-size: 0.85rem; border-top: 2px solid var(--border-color); margin-top: 2rem; }

        /* --- STYLE DO DRUKU --- */
        @media print {
            body { background: white; color: black; }
            .sidebar, .header, .footer, .btn-primary, .btn-secondary, form, #form-shipment-container, #form-components-container, #form-incoming-container, #form-production-container, #form-adjustments-container { display: none !important; }
            .main-content { margin-left: 0; padding: 0; }
            .content { padding: 0; }
            .section { box-shadow: none; border: 1px solid #ccc; margin-bottom: 1rem; page-break-inside: avoid; }
            .tab-content { display: block !important; } 
            #tab-dashboard, #tab-history, #tab-reports { display: none !important; } 
        }

        @media (max-width: 768px) {
            #app-container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; position: static; padding: 1rem 0; }
            .main-content { margin-left: 0; }
            .stats-bar { grid-template-columns: 1fr; }
            .header { flex-direction: column; align-items: flex-start; gap: 1rem; }
            .user-badge { flex-direction: column; text-align: center; gap: 5px; }
        }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box">
            <h2><span style="font-size: 2rem;">‚ìÇÔ∏è</span> MASTERLIGHT</h2>
            <p style="margin-bottom: 1.5rem; color: var(--text-light);">Zaloguj siƒô do systemu chmurowego</p>
            <form id="login-form">
                <div class="form-group" style="text-align: left;">
                    <label>E-mail</label>
                    <input type="email" id="login-email" required placeholder="np. admin@masterlight.pl">
                </div>
                <div class="form-group" style="text-align: left;">
                    <label>Has≈Ço</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 1rem; padding: 0.8rem;">Zaloguj siƒô</button>
            </form>
            <p id="login-error" style="color: var(--accent-red); margin-top: 1rem; display: none;"></p>
        </div>
    </div>

    <div id="app-container" class="hidden" style="display: flex; width: 100%; height: 100vh;">
        
        <aside class="sidebar">
            <div class="sidebar-logo">
                <h2><span style="font-size: 2rem;">‚ìÇÔ∏è</span> MASTERLIGHT</h2>
            </div>
            <nav class="sidebar-nav">
                <ul id="nav-list">
                    <li><a href="#" onclick="switchTab('tab-dashboard')" class="nav-item active">üìä Dashboard</a></li>
                    <li><a href="#" onclick="switchTab('tab-inventory')" class="nav-item">üì¶ Inwentarz</a></li>
                    <li><a href="#" onclick="switchTab('tab-shipments')" class="nav-item">üöö Dostawy</a></li>
                    <li><a href="#" onclick="switchTab('tab-adjustments')" class="nav-item">üõ†Ô∏è Regulacja Lamp</a></li>
                    <li id="nav-history"><a href="#" onclick="switchTab('tab-history')" class="nav-item">üìã Historia</a></li>
                    <li><a href="#" onclick="switchTab('tab-components')" class="nav-item">‚ö° Komponenty</a></li>
                    <li id="nav-reports"><a href="#" onclick="switchTab('tab-reports')" class="nav-item">üîß Produkcja</a></li>
                </ul>
            </nav>
        </aside>

        <div class="main-content">
            <header class="header">
                <div class="header-title">
                    <h1><span style="font-size: 2.5rem;">‚ìÇÔ∏è</span> MASTERLIGHT</h1>
                    <p>System ZarzƒÖdzania Magazynem - Baza danych w Chmurze</p>
                </div>
                <div class="user-badge" id="user-info">
                    <div>
                        üë§ Zalogowano: <strong id="logged-email">...</strong> <br>
                        üõ°Ô∏è Rola: <strong id="logged-role">...</strong>
                    </div>
                    <button onclick="logoutUser()" class="btn-secondary btn-small" style="margin: 0; height: fit-content;">üö™ Wyloguj</button>
                </div>
            </header>

            <div class="content">
                <div id="tab-dashboard" class="tab-content active">
                    <h2 style="margin-bottom: 1.5rem; color: var(--text-dark);">Dashboard</h2>
                    <div class="stats-bar">
                        <div class="stat-card"><h3>Razem Downlighty</h3><div class="value" data-stat="total">0</div></div>
                        <div class="stat-card"><h3>Gotowe do Wysy≈Çki</h3><div class="value" data-stat="ready">0</div></div>
                        <div class="stat-card"><h3>Potwierdzone Dostawy</h3><div class="value" data-stat="shipments">0</div></div>
                        <div class="stat-card"><h3>Oprawy w Serwisie</h3><div class="value" data-stat="service">0</div></div>
                    </div>
                    <div class="section">
                        <div class="section-header"><h2>Stany Downlight√≥w - Gotowe do Wysy≈Çki</h2></div>
                        <div class="section-content">
                            <table>
                                <thead><tr><th>Produkt</th><th>Ilo≈õƒá Gotowych</th><th>Status</th></tr></thead>
                                <tbody id="products-dashboard"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="tab-inventory" class="tab-content">
                    <h2 style="margin-bottom: 1.5rem; color: var(--text-dark);">Downlighty - Wszystkie</h2>
                    <div class="section">
                        <div class="section-header"><h2>Stan Magazynowy Downlight√≥w</h2></div>
                        <div class="section-content">
                            <button class="btn-primary" onclick="window.print()" style="margin-bottom: 1.5rem;">üì• Eksportuj do PDF / Drukuj</button>
                            <table>
                                <thead><tr><th>Produkt</th><th>SKU</th><th>Gotowe</th><th>W Monta≈ºu</th><th>Razem</th><th>Status</th></tr></thead>
                                <tbody id="products-table"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-header"><h2>Oprawy w Serwisie</h2></div>
                        <div class="section-content">
                            <table>
                                <thead><tr><th>Produkt</th><th>Ilo≈õƒá w serwisie</th></tr></thead>
                                <tbody id="service-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="tab-shipments" class="tab-content">
                    <h2 style="margin-bottom: 1.5rem; color: var(--text-dark);">ZarzƒÖdzanie Dostawami</h2>
                    
                    <div id="form-incoming-container" class="section">
                        <div class="section-header"><h2>üì¶ Zarejestruj Dostawƒô PrzychodzƒÖcƒÖ (Dopisz do monta≈ºu)</h2></div>
                        <div class="section-content">
                            <form id="incomingForm">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                    <div class="form-group"><label>Dostawca</label><input type="text" name="supplier" required></div>
                                    <div class="form-group"><label>22¬∞</label><input type="number" name="p1" value="0" min="0"></div>
                                    <div class="form-group"><label>37¬∞</label><input type="number" name="p2" value="0" min="0"></div>
                                    <div class="form-group"><label>58¬∞</label><input type="number" name="p3" value="0" min="0"></div>
                                </div>
                                <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                                    <button type="submit" class="btn-primary">üì• Zarejestruj Dostawƒô</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-header"><h2 style="color: #CD853F;">‚è≥ Dostawy OczekujƒÖce (Niepotwierdzona Data)</h2></div>
                        <div class="section-content">
                            <table>
                                <thead><tr><th>Data Wstƒôpna</th><th>Miejsce</th><th>Firma OdbierajƒÖca</th><th>Sztuk</th><th>KƒÖty</th><th>Status</th><th class="admin-only-col">Akcja</th></tr></thead>
                                <tbody id="shipments-unconfirmed-table"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-header"><h2>üöö Dostawy Potwierdzone i Zrealizowane</h2><div class="badge" id="shipments-count">0 dostaw</div></div>
                        <div class="section-content">
                            <button class="btn-primary" onclick="window.print()" style="margin-bottom: 1.5rem;">üì• Wydrukuj listƒô dostaw</button>
                            <table>
                                <thead><tr><th>Data Potwierdzona</th><th>Miejsce</th><th>Firma OdbierajƒÖca</th><th>Sztuk</th><th>KƒÖty</th><th>Status</th><th class="admin-only-col">Akcja</th></tr></thead>
                                <tbody id="shipments-confirmed-table"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="form-shipment-container" class="section">
                        <div class="section-header"><h2>Zaplanuj NowƒÖ Dostawƒô Do Klienta</h2></div>
                        <div class="section-content">
                            <form id="shipmentForm">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                    <div class="form-group"><label>Data Wstƒôpna</label><input type="date" name="date" required></div>
                                    <div class="form-group"><label>Miejsce</label><input type="text" name="location" required></div>
                                    <div class="form-group"><label>Firma OdbierajƒÖca</label><input type="text" name="company" placeholder="np. DPD, W≈Çasna" required></div>
                                    <div class="form-group"><label>22¬∞-15W</label><input type="number" name="p1" value="0" min="0"></div>
                                    <div class="form-group"><label>37¬∞-15W</label><input type="number" name="p2" value="0" min="0"></div>
                                    <div class="form-group"><label>58¬∞-15W</label><input type="number" name="p3" value="0" min="0"></div>
                                    <div class="form-group"><label>37¬∞-20W</label><input type="number" name="p4" value="0" min="0"></div>
                                    <div class="form-group"><label>58¬∞-20W</label><input type="number" name="p5" value="0" min="0"></div>
                                </div>
                                <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                                    <button type="submit" class="btn-primary">üì§ Dodaj Dostawƒô</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div id="tab-adjustments" class="tab-content">
                    <h2 style="margin-bottom: 1.5rem; color: var(--text-dark);">Regulacja Lamp (Wyjazdy)</h2>
                    
                    <div class="section">
                        <div class="section-header"><h2>Lista zaplanowanych regulacji</h2></div>
                        <div class="section-content">
                            <table>
                                <thead><tr><th>Data Regulacji</th><th>Miejscowo≈õƒá</th><th class="admin-only-col">Akcja</th></tr></thead>
                                <tbody id="adjustments-table"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="form-adjustments-container" class="section">
                        <div class="section-header"><h2>‚ûï Zaplanuj NowƒÖ Regulacjƒô</h2></div>
                        <div class="section-content">
                            <form id="adjustmentForm">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                    <div class="form-group"><label>Data Wyjazdu</label><input type="date" name="adj_date" required></div>
                                    <div class="form-group"><label>Miejscowo≈õƒá</label><input type="text" name="adj_location" required placeholder="np. Warszawa"></div>
                                </div>
                                <div style="margin-top: 1.5rem;"><button type="submit" class="btn-primary">üíæ Dodaj Regulacjƒô</button></div>
                            </form>
                        </div>
                    </div>
                </div>

                <div id="tab-history" class="tab-content">
                    <h2 style="margin-bottom: 1.5rem; color: var(--text-dark);">Historia Operacji</h2>
                    <div class="section">
                        <div class="section-header"><h2>Pe≈Çna Historia (Tylko Szefostwo / Admin)</h2></div>
                        <div class="section-content">
                            <button class="btn-primary" onclick="window.print()" style="margin-bottom: 1.5rem;">üì• Drukuj Logi</button>
                            <table>
                                <thead><tr><th>Czas</th><th>Typ Operacji</th><th>Szczeg√≥≈Çy</th></tr></thead>
                                <tbody id="history-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="tab-components" class="tab-content">
                    <h2 style="margin-bottom: 1.5rem; color: var(--text-dark);">Komponenty</h2>
                    
                    <div id="form-components-container" class="section">
                        <div class="section-header"><h2>üì¶ Dodaj Dostawƒô Komponent√≥w</h2></div>
                        <div class="section-content">
                            <form id="componentsIncomingForm">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                    <div class="form-group"><label>Dostawca</label><input type="text" name="supplier" required></div>
                                    <div class="form-group"><label>Zasilacze</label><input type="number" name="ps_raw" value="0" min="0"></div>
                                    <div class="form-group"><label>Klapki Zwyk≈Çe</label><input type="number" name="clips_normal" value="0" min="0"></div>
                                    <div class="form-group"><label>Klapki Przelotowe</label><input type="number" name="clips_pass" value="0" min="0"></div>
                                </div>
                                <div style="margin-top: 1.5rem;"><button type="submit" class="btn-primary">üì• Zarejestruj</button></div>
                            </form>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-header"><h2>‚ö° Zasilacze i Klapki (Stan)</h2></div>
                        <div class="section-content">
                            <table>
                                <thead><tr><th>Typ</th><th>Ilo≈õƒá</th></tr></thead>
                                <tbody>
                                    <tr><td><strong>Zasilacze</strong></td><td onclick="editComponentCell(this, 'ps_raw')" class="editable" id="ps-raw-cell">0</td></tr>
                                    <tr><td><strong>Klapki Zwyk≈Çe</strong></td><td onclick="editComponentCell(this, 'clips_normal')" class="editable" id="clips-normal-cell">0</td></tr>
                                    <tr><td><strong>Klapki Przelotowe</strong></td><td onclick="editComponentCell(this, 'clips_pass')" class="editable" id="clips-pass-cell">0</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="tab-reports" class="tab-content">
                    <h2 style="margin-bottom: 1.5rem; color: var(--text-dark);">Raporty - Produkcja</h2>
                    
                    <div id="form-production-container" class="section">
                        <div class="section-header"><h2>üîß Rejestracja Produkcji</h2></div>
                        <div class="section-content">
                            <form id="productionForm">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                    <div class="form-group"><label>22¬∞-15W</label><input type="number" name="p1" value="0" min="0"></div>
                                    <div class="form-group"><label>37¬∞-15W</label><input type="number" name="p2" value="0" min="0"></div>
                                    <div class="form-group"><label>58¬∞-15W</label><input type="number" name="p3" value="0" min="0"></div>
                                    <div class="form-group"><label>37¬∞-20W</label><input type="number" name="p4" value="0" min="0"></div>
                                    <div class="form-group"><label>58¬∞-20W</label><input type="number" name="p5" value="0" min="0"></div>
                                </div>
                                <div style="margin-top: 1.5rem;"><button type="submit" class="btn-primary">‚úÖ Zarejestruj Produkcjƒô</button></div>
                            </form>
                            <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
                                ‚ÑπÔ∏è Podane ilo≈õci zostanƒÖ odjƒôte z kolumny "W Monta≈ºu" (jako wsp√≥lna pula) i dodane do "Gotowe do Wysy≈Çki".<br>
                                ‚ö†Ô∏è Na ka≈ºdy wyprodukowany downlight zu≈ºywa siƒô: 1x zasilacz, 1x klapka zwyk≈Ça, 1x klapka przelotowa.
                            </p>
                        </div>
                    </div>
                </div>

                <footer class="footer">
                    <p>¬© 2026 Masterlight - Wersja Chmurowa ‚òÅÔ∏è</p>
                </footer>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h2 id="modal-title" style="margin: 0; color: var(--text-dark);">...</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modal-content" class="modal-body"></div>
        </div>
    </div>

    <script>
        // ==========================================
        // ===== KONFIGURACJA SUPABASE =====
        // ==========================================
        const supabaseUrl = 'https://ghdswvjhqpxupzcrixlu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdoZHN3dmpocXB4dXB6Y3JpeGx1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTEwMDAsImV4cCI6MjA4NzQyNzAwMH0._sk7mCv27tC153DTvqp_7O3CUyYsk3iuYuf0f93GCfo';
        
        // ==========================================
        // ===== KONFIGURACJA UPRAWNIE≈É (R√ìL) =====
        // ==========================================
        const ROLES = {
            'b.hajduk@masterlight.pl': 'admin',      
            'm.olejnik@masterlight.pl': 'viewer',         
            'f.robert@interia.pl': 'viewer',         
            'd.lewandowska@masterlight.pl': 'worker'      
        };

        let currentUserEmail = '';
        let currentRole = 'viewer';

        const db = window.supabase.createClient(supabaseUrl, supabaseKey);

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error');
            const submitBtn = document.querySelector('#login-form button');
            
            errorElement.style.display = 'none';
            submitBtn.textContent = 'Logowanie...';

            const { data, error } = await db.auth.signInWithPassword({ email, password });

            if (error) {
                console.error("B≈ÇƒÖd logowania:", error.message);
                errorElement.textContent = 'B≈Çƒôdny e-mail lub has≈Ço!';
                errorElement.style.display = 'block';
                submitBtn.textContent = 'Zaloguj siƒô';
            } else {
                initApp(data.user); 
            }
        });

        async function checkSession() {
            const { data: { session } } = await db.auth.getSession();
            if (session) initApp(session.user);
        }

        function initApp(user) {
            currentUserEmail = user.email;
            currentRole = ROLES[currentUserEmail] || 'viewer'; 

            document.getElementById('logged-email').textContent = currentUserEmail;
            
            let roleText = 'Obserwator (Tylko PodglƒÖd)';
            if (currentRole === 'admin') roleText = 'Kierownik (Pe≈Çen Dostƒôp)';
            if (currentRole === 'worker') roleText = 'Pracownik (Edycja Magazynu)';
            document.getElementById('logged-role').textContent = roleText;

            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            applyPermissions();

            window.inventory = new CloudInventoryManager();
            window.inventory.init();
        }

        function applyPermissions() {
            if (currentRole === 'viewer') {
                document.getElementById('form-shipment-container').style.display = 'none';
                document.getElementById('form-incoming-container').style.display = 'none';
                document.getElementById('form-components-container').style.display = 'none';
                document.getElementById('form-production-container').style.display = 'none';
                document.getElementById('form-adjustments-container').style.display = 'none';
                document.getElementById('nav-history').style.display = 'none';
                document.getElementById('nav-reports').style.display = 'none';
                document.querySelectorAll('.editable').forEach(el => el.classList.remove('editable'));
                document.querySelectorAll('.admin-only-col').forEach(el => el.style.display = 'none');
            }
            
            if (currentRole === 'worker') {
                document.getElementById('nav-history').style.display = 'none';
            }
        }

        async function logoutUser() {
            await db.auth.signOut();
            window.location.reload(); 
        }

        checkSession();

        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        class CloudInventoryManager {
            constructor() {
                this.products = [];
                this.shipments = [];
                this.history = [];
                this.adjustments = [];
                this.components = { ps_raw: 0, clips_normal: 0, clips_pass: 0 };
                this.realtimeTimeout = null;
            }

            async init() {
                await this.fetchData();
                this.setupRealtime();
            }

            // OPTYMALIZACJA 1: PROMISE.ALL DLA ZAPYTA≈É DO BAZY (Dzia≈Ça 5x szybciej)
            async fetchData() {
                const [prodsRes, compsRes, shipsRes, adjsRes, histRes] = await Promise.all([
                    db.from('products').select('*').order('id'),
                    db.from('components').select('*').eq('id', 1).single(),
                    db.from('shipments').select('*').order('date'),
                    db.from('adjustments').select('*').order('date'),
                    db.from('history').select('*').order('created_at', { ascending: false }).limit(20)
                ]);

                if (prodsRes.data) this.products = prodsRes.data;
                if (compsRes.data) this.components = compsRes.data;
                if (shipsRes.data) this.shipments = shipsRes.data;
                if (adjsRes.data) this.adjustments = adjsRes.data;
                if (histRes.data) {
                    this.history = histRes.data.map(h => ({ 
                        timestamp: new Date(h.created_at).toLocaleString('pl-PL'), 
                        action: h.action, details: h.details 
                    }));
                }

                // AKTUALIZACJA DAT
                const todayObj = new Date();
                const yyyy = todayObj.getFullYear();
                const mm = String(todayObj.getMonth() + 1).padStart(2, '0');
                const dd = String(todayObj.getDate()).padStart(2, '0');
                const todayFormatted = `${yyyy}-${mm}-${dd}`;

                const dbUpdates = [];
                for (let s of this.shipments) {
                    if (s.status !== 'completed' && s.date < todayFormatted) {
                        if (currentRole === 'admin' || currentRole === 'worker') {
                            dbUpdates.push(db.from('shipments').update({ date: todayFormatted }).eq('id', s.id));
                        }
                        s.date = todayFormatted;
                    }
                }
                if (dbUpdates.length > 0) await Promise.all(dbUpdates);

                updateDashboard();
            }

            // OPTYMALIZACJA 2: DEBOUNCING REALTIME (Nie laguje przy wielu zmianach naraz)
            setupRealtime() {
                db.channel('public:all')
                    .on('postgres_changes', { event: '*', schema: 'public' }, payload => {
                        clearTimeout(this.realtimeTimeout);
                        this.realtimeTimeout = setTimeout(() => {
                            this.fetchData();
                        }, 400); 
                    }).subscribe();
            }

            async addHistory(action, details) {
                const detailWithUser = `${details} (User: ${currentUserEmail})`;
                await db.from('history').insert([{ action, details: detailWithUser }]);
            }

            getStatus(productId) {
                const product = this.products.find(p => p.id === productId);
                if (!product) return 'unknown';
                const total = product.ready + product.assembly + (product.service || 0);
                if (total === 0) return 'error';
                if (total >= 50) return 'ok';
                return 'warning';
            }

            async updateProduct(id, updates) {
                if (currentRole === 'viewer') return; 
                const product = this.products.find(p => p.id === id);
                if (product) {
                    await db.from('products').update(updates).eq('id', id);
                    if (updates.assembly !== undefined && product.assembly_group) {
                        await db.from('products').update({ assembly: updates.assembly }).eq('assembly_group', product.assembly_group);
                    }
                    this.addHistory('Edycja produktu', `${product.name}`);
                }
            }

            async addAdjustment(date, location) {
                if (currentRole === 'viewer') return;
                await db.from('adjustments').insert([{ date, location }]);
                this.addHistory('Dodano wyjazd serwisowy', `${location} - ${date}`);
            }

            async deleteAdjustment(id) {
                if (currentRole !== 'admin') return;
                await db.from('adjustments').delete().eq('id', id);
                this.addHistory('Usuniƒôto wyjazd serwisowy', `Usuniƒôto z bazy`);
            }

            async addShipment(shipment) {
                if (currentRole === 'viewer') return;
                await db.from('shipments').insert([{ 
                    date: shipment.date, 
                    location: shipment.location, 
                    company: shipment.company,
                    products: shipment.products, 
                    status: 'planned',
                    is_confirmed: false
                }]);
                this.addHistory('Nowa zaplanowana dostawa', `${shipment.location} (${shipment.company})`);
            }

            async confirmShipment(id) {
                if (currentRole === 'viewer') return;
                const shipment = this.shipments.find(s => s.id === id);
                if (shipment) {
                    await db.from('shipments').update({ is_confirmed: true }).eq('id', id);
                    this.addHistory('Potwierdzono datƒô dostawy', `${shipment.location}`);
                }
            }

            async deleteShipment(id) {
                if (currentRole !== 'admin') return;
                await db.from('shipments').delete().eq('id', id);
                this.addHistory('Usuniƒôto dostawƒô', `Z systemu usuniƒôto zam√≥wienie`);
            }

            async updateShipmentDateInDB(id, newDate) {
                if (currentRole === 'viewer') return;
                const shipment = this.shipments.find(s => s.id === id);
                if (shipment) {
                    await db.from('shipments').update({ date: newDate }).eq('id', id);
                    this.addHistory('Zmiana daty dostawy', `${shipment.location}: na ${newDate}`);
                }
            }

            // OPTYMALIZACJA 3: ZBIORCZE UPDATE BAZY
            async completeShipment(id) {
                if (currentRole === 'viewer') return;
                const shipment = this.shipments.find(s => s.id === id);
                if (!shipment) return;

                const missing = {};
                const updates = []; 

                for (const productId of Object.keys(shipment.products)) {
                    const quantity = shipment.products[productId];
                    if (quantity > 0) {
                        const product = this.products.find(p => p.id === parseInt(productId));
                        if (product) {
                            const toDeduct = Math.min(quantity, product.ready);
                            const newReady = product.ready - toDeduct;
                            const lack = quantity - toDeduct;

                            if (lack > 0) missing[productId] = lack;
                            if (toDeduct > 0) updates.push(db.from('products').update({ ready: newReady }).eq('id', product.id));
                        }
                    }
                }

                if (updates.length > 0) await Promise.all(updates);

                let newStatus = 'completed';
                let partialMissing = null;
                let historyMsg = '';

                if (Object.keys(missing).length > 0) {
                    newStatus = 'partial';
                    partialMissing = missing;
                    historyMsg = `Dostawa niepe≈Çna: ${shipment.location} (braki)`;
                } else {
                    historyMsg = `Dostawa zrealizowana: ${shipment.location}`;
                }

                await db.from('shipments').update({ status: newStatus, partial_missing: partialMissing, is_confirmed: true }).eq('id', id);
                this.addHistory(newStatus === 'completed' ? 'Dostawa zrealizowana' : 'Dostawa niepe≈Çna', historyMsg);
            }

            async completeRemainingShipment(id) {
                if (currentRole === 'viewer') return;
                const shipment = this.shipments.find(s => s.id === id);
                if (!shipment || shipment.status !== 'partial' || !shipment.partial_missing) return;

                const missing = shipment.partial_missing;
                const stillMissing = {};
                const updates = [];

                for (const productId of Object.keys(missing)) {
                    const need = missing[productId];
                    const product = this.products.find(p => p.id === parseInt(productId));
                    if (product) {
                        const toDeduct = Math.min(need, product.ready);
                        const newReady = product.ready - toDeduct;
                        const left = need - toDeduct;

                        if (left > 0) stillMissing[productId] = left;
                        if (toDeduct > 0) updates.push(db.from('products').update({ ready: newReady }).eq('id', product.id));
                    }
                }

                if (updates.length > 0) await Promise.all(updates);

                let newStatus = 'completed';
                let newPartialMissing = null;
                let historyMsg = '';

                if (Object.keys(stillMissing).length > 0) {
                    newStatus = 'partial';
                    newPartialMissing = stillMissing;
                    historyMsg = `Doko≈Ñczenie dostawy (wciƒÖ≈º sƒÖ braki): ${shipment.location}`;
                } else {
                    historyMsg = `Doko≈Ñczenie dostawy: ${shipment.location} (teraz kompletna)`;
                }

                await db.from('shipments').update({ status: newStatus, partial_missing: newPartialMissing }).eq('id', id);
                this.addHistory('Doko≈Ñczenie dostawy', historyMsg);
            }

            async addIncomingShipment(supplier, newProducts) {
                if (currentRole === 'viewer') return;
                let totalAdded = 0;
                const dbUpdates = [];
                
                for (const [id, qty] of Object.entries(newProducts)) {
                    if (qty > 0) {
                        const product = this.products.find(p => p.id === parseInt(id));
                        if (product) {
                            const newAssembly = product.assembly + qty;
                            if (product.assembly_group) {
                                dbUpdates.push(db.from('products').update({ assembly: newAssembly }).eq('assembly_group', product.assembly_group));
                                this.products.filter(p => p.assembly_group === product.assembly_group).forEach(p => p.assembly = newAssembly);
                            } else {
                                dbUpdates.push(db.from('products').update({ assembly: newAssembly }).eq('id', product.id));
                                product.assembly = newAssembly;
                            }
                            totalAdded += qty;
                        }
                    }
                }
                
                if (dbUpdates.length > 0) await Promise.all(dbUpdates);

                if (totalAdded > 0) {
                    this.addHistory('Dostawa przychodzƒÖca', `${supplier} - dodano ${totalAdded} szt obud√≥w`);
                }
            }

            async registerProduction(produced) {
                if (currentRole === 'viewer') return;
                
                const totalToProduce = Object.values(produced).reduce((sum, val) => sum + val, 0);
                if (totalToProduce === 0) return;

                const { ps_raw, clips_normal, clips_pass } = this.components;
                const componentsAvailable = Math.min(ps_raw, clips_normal, clips_pass);

                if (totalToProduce > componentsAvailable) {
                    alert(`‚ö†Ô∏è NiewystarczajƒÖca liczba komponent√≥w! Masz zestaw√≥w tylko dla ${componentsAvailable} szt.`);
                    return; 
                }

                const groupReq = {};
                for (const [id, qty] of Object.entries(produced)) {
                    if (qty > 0) {
                        const product = this.products.find(p => p.id === parseInt(id));
                        if (product) {
                            const key = product.assembly_group || `single_${product.id}`;
                            groupReq[key] = (groupReq[key] || 0) + qty;
                        }
                    }
                }

                for (const [key, qtyReq] of Object.entries(groupReq)) {
                    let available = 0;
                    if (key.startsWith('single_')) {
                        const pid = parseInt(key.replace('single_', ''));
                        available = this.products.find(p => p.id === pid).assembly;
                    } else {
                        const p = this.products.find(p => p.assembly_group === key);
                        available = p ? p.assembly : 0;
                    }
                    
                    if (qtyReq > available) {
                        alert(`‚ùå Zbyt ma≈Ço opraw "W Monta≈ºu" dla puli ${key === '37' || key === '58' ? key + '¬∞' : key}. Wymagane ${qtyReq}, a masz ${available}.`);
                        return; 
                    }
                }

                let totalProduced = 0;
                const details = [];
                const dbUpdates = [];

                for (const [id, qty] of Object.entries(produced)) {
                    if (qty > 0) {
                        const product = this.products.find(p => p.id === parseInt(id));
                        if (product) {
                            const newReady = product.ready + qty;
                            const newAssembly = product.assembly - qty;

                            dbUpdates.push(db.from('products').update({ ready: newReady }).eq('id', product.id));
                            product.ready = newReady;

                            if (product.assembly_group) {
                                dbUpdates.push(db.from('products').update({ assembly: newAssembly }).eq('assembly_group', product.assembly_group));
                                this.products.filter(p => p.assembly_group === product.assembly_group).forEach(p => p.assembly = newAssembly);
                            } else {
                                dbUpdates.push(db.from('products').update({ assembly: newAssembly }).eq('id', product.id));
                                product.assembly = newAssembly;
                            }

                            totalProduced += qty;
                            details.push(`${product.name}: ${qty} szt`);
                        }
                    }
                }

                if (totalProduced > 0) {
                    dbUpdates.push(db.from('components').update({
                        ps_raw: ps_raw - totalProduced,
                        clips_normal: clips_normal - totalProduced,
                        clips_pass: clips_pass - totalProduced
                    }).eq('id', 1));

                    await Promise.all(dbUpdates);
                    this.addHistory('Rejestracja produkcji', details.join(', '));
                    alert(`‚úÖ Wyprodukowano: ${totalProduced} szt.`);
                    // UI zaktualizuje sie samo przez realtime, opcjonalnie odswiez lokalnie
                }
            }

            getTotals() {
                const processedGroups = new Set();
                let totalAssembly = 0;
                this.products.forEach(p => {
                    if (p.assembly_group) {
                        if (!processedGroups.has(p.assembly_group)) { totalAssembly += p.assembly; processedGroups.add(p.assembly_group); }
                    } else { totalAssembly += p.assembly; }
                });
                const totalReady = this.products.reduce((s, p) => s + p.ready, 0);
                const totalService = this.products.reduce((s, p) => s + (p.service || 0), 0);
                return { totalReady, totalAssembly, totalService, totalAll: totalReady + totalAssembly + totalService };
            }

            async updateComponent(field, value) {
                if (currentRole === 'viewer') return;
                await db.from('components').update({ [field]: value }).eq('id', 1);
                this.addHistory('Edycja komponentu', `Zaktualizowano stan zasilaczy/klapek`);
            }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        function getStatusClass(productId) {
            const status = window.inventory.getStatus(productId);
            return status === 'ok' ? 'status-ok' : status === 'warning' ? 'status-warning' : 'status-error';
        }

        function getStatusText(productId) {
            const status = window.inventory.getStatus(productId);
            return status === 'ok' ? '‚úì OK' : status === 'warning' ? '‚ö† Ma≈Ço' : '‚õî Brak';
        }

        function updateDashboard() {
            if(!window.inventory || window.inventory.products.length === 0) return;
            
            const totals = window.inventory.getTotals();
            document.querySelector('[data-stat="total"]').textContent = totals.totalAll;
            document.querySelector('[data-stat="ready"]').textContent = totals.totalReady;
            document.querySelector('[data-stat="shipments"]').textContent = window.inventory.shipments.filter(s => s.status !== 'completed' && s.is_confirmed).length;
            document.querySelector('[data-stat="service"]').textContent = totals.totalService;

            const dashboardTbody = document.getElementById('products-dashboard');
            dashboardTbody.innerHTML = '';
            window.inventory.products.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${p.name}</td><td>${p.ready}</td><td><span class="status-badge ${getStatusClass(p.id)}">${getStatusText(p.id)}</span></td>`;
                dashboardTbody.appendChild(row);
            });

            updateInventoryTable();
            updateShipmentsTables();
            updateAdjustmentsTable();
            if(currentRole !== 'worker') updateHistoryTable(); 
            updateComponentsDisplay();
        }

        function updateInventoryTable() {
            const tbody = document.getElementById('products-table');
            const tbodyService = document.getElementById('service-table');
            tbody.innerHTML = '';
            tbodyService.innerHTML = '';
            const isViewer = currentRole === 'viewer';
            
            window.inventory.products.forEach(p => {
                const total = p.ready + p.assembly + (p.service || 0);
                const row = document.createElement('tr');
                const readyCell = isViewer ? `<td>${p.ready}</td>` : `<td onclick="editCell(this, 'ready', ${p.id})" class="editable">${p.ready}</td>`;
                const assemblyCell = isViewer ? `<td>${p.assembly}</td>` : `<td onclick="editCell(this, 'assembly', ${p.id})" class="editable">${p.assembly}</td>`;

                row.innerHTML = `
                    <td>${p.name}</td><td>${p.sku}</td>
                    ${readyCell}
                    ${assemblyCell}
                    <td><strong>${total}</strong></td>
                    <td><span class="status-badge ${getStatusClass(p.id)}">${getStatusText(p.id)}</span></td>
                `;
                tbody.appendChild(row);

                const serviceRow = document.createElement('tr');
                const serviceCell = isViewer ? `<td>${p.service || 0}</td>` : `<td onclick="editCell(this, 'service', ${p.id})" class="editable">${p.service || 0}</td>`;
                serviceRow.innerHTML = `<td>${p.name}</td>${serviceCell}`;
                tbodyService.appendChild(serviceRow);
            });
        }

        function renderShipmentRow(s, isConfirmedTable) {
            let total = 0;
            if(s.products) { total = Object.values(s.products).reduce((a, b) => a + b, 0); }
            
            let statusBadge = '';
            if (s.status === 'completed') statusBadge = '<span class="status-badge status-ok">‚úì Zrealizowana</span>';
            else if (s.status === 'partial') statusBadge = '<span class="status-badge status-warning">‚ö† Niepe≈Çna</span>';
            else if (s.is_confirmed) statusBadge = '<span class="status-badge status-neutral">üìÖ Potwierdzona</span>';
            else statusBadge = '<span class="status-badge status-warning">‚è≥ OczekujƒÖca</span>';

            let actionButton = '';
            
            if (currentRole !== 'viewer') {
                if (!s.is_confirmed && s.status === 'planned') {
                    actionButton = `<button class="btn-small btn-primary" onclick="confirmShipmentDateUI(${s.id})">‚úì Potwierd≈∫ Datƒô</button>
                                    <button class="btn-small btn-secondary" onclick="editShipmentDate(${s.id})">üìÖ Zmie≈Ñ Datƒô</button>`;
                    if (currentRole === 'admin') actionButton += ` <button class="btn-small btn-secondary" onclick="deleteShipment(${s.id})">üóëÔ∏è Usu≈Ñ</button>`;
                } else if (s.status === 'completed') {
                    if (currentRole === 'admin') actionButton = `<button class="btn-small btn-secondary" onclick="deleteShipment(${s.id})">üóëÔ∏è Usu≈Ñ</button>`;
                } else if (s.status === 'partial') {
                    actionButton = `<button class="btn-small btn-primary" onclick="completeRemainingShipmentUI(${s.id})">‚úì Doko≈Ñcz</button> 
                                    <button class="btn-small btn-secondary" onclick="printMissingPdf(${s.id})">üìÑ PDF Braki</button>
                                    <button class="btn-small btn-secondary" onclick="editShipmentDate(${s.id})">üìÖ Data</button>`;
                    if (currentRole === 'admin') actionButton += ` <button class="btn-small btn-secondary" onclick="deleteShipment(${s.id})">üóëÔ∏è Usu≈Ñ</button>`;
                } else {
                    actionButton = `<button class="btn-small btn-primary" onclick="completeShipmentUI(${s.id})">‚úì Zrealizuj</button>
                                    <button class="btn-small btn-secondary" onclick="editShipmentDate(${s.id})">üìÖ Data</button>`;
                    if (currentRole === 'admin') actionButton += ` <button class="btn-small btn-secondary" onclick="deleteShipment(${s.id})">üóëÔ∏è Usu≈Ñ</button>`;
                }
            } else {
                if (s.status === 'partial') actionButton = `<button class="btn-small btn-secondary" onclick="printMissingPdf(${s.id})">üìÑ PDF Braki</button>`;
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${s.date}</strong></td>
                <td>${s.location}</td>
                <td>${s.company || '-'}</td>
                <td><strong>${total}</strong></td>
                <td><button class="btn-small btn-secondary" onclick="showAnglesDemand(${s.id})" style="margin:0; background-color:#8B6F47; border-color:#8B6F47;">üëÅÔ∏è KƒÖty</button></td>
                <td>${statusBadge}</td>
                ${currentRole !== 'viewer' || s.status === 'partial' ? `<td>${actionButton}</td>` : '<td class="admin-only-col"></td>'}
            `;
            return row;
        }

        function updateShipmentsTables() {
            const tbodyUnconf = document.getElementById('shipments-unconfirmed-table');
            const tbodyConf = document.getElementById('shipments-confirmed-table');
            tbodyUnconf.innerHTML = '';
            tbodyConf.innerHTML = '';

            let confCount = 0;

            window.inventory.shipments.forEach(s => {
                if (!s.is_confirmed && s.status === 'planned') {
                    tbodyUnconf.appendChild(renderShipmentRow(s, false));
                } else {
                    tbodyConf.appendChild(renderShipmentRow(s, true));
                    confCount++;
                }
            });
            document.getElementById('shipments-count').textContent = confCount + ' dostaw';
        }

        function updateAdjustmentsTable() {
            const tbody = document.getElementById('adjustments-table');
            if(!tbody) return;
            tbody.innerHTML = '';
            window.inventory.adjustments.forEach(a => {
                const row = document.createElement('tr');
                const actionCell = currentRole === 'admin' ? `<td><button class="btn-small btn-secondary" onclick="deleteAdjustment(${a.id})">üóëÔ∏è Usu≈Ñ</button></td>` : `<td class="admin-only-col"></td>`;
                row.innerHTML = `<td><strong>${a.date}</strong></td><td>${a.location}</td>${actionCell}`;
                tbody.appendChild(row);
            });
        }

        function updateHistoryTable() {
            const tbody = document.getElementById('history-table');
            if(!tbody) return;
            tbody.innerHTML = '';
            window.inventory.history.slice(0, 20).forEach(h => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${h.timestamp}</td><td>${h.action}</td><td>${h.details}</td>`;
                tbody.appendChild(row);
            });
        }

        function updateComponentsDisplay() {
            if(!window.inventory.components) return;
            const isViewer = currentRole === 'viewer';
            const rawEl = document.getElementById('ps-raw-cell');
            const normEl = document.getElementById('clips-normal-cell');
            const passEl = document.getElementById('clips-pass-cell');

            rawEl.textContent = window.inventory.components.ps_raw;
            normEl.textContent = window.inventory.components.clips_normal;
            passEl.textContent = window.inventory.components.clips_pass;

            if (isViewer) {
                rawEl.classList.remove('editable'); rawEl.onclick = null;
                normEl.classList.remove('editable'); normEl.onclick = null;
                passEl.classList.remove('editable'); passEl.onclick = null;
            }
        }

        function editCell(cell, field, productId) {
            if (currentRole === 'viewer') return;
            if (cell.querySelector('input')) return;
            const product = window.inventory.products.find(p => p.id === productId);
            const input = document.createElement('input');
            input.type = 'number'; input.value = product[field] || 0; input.style.width = '100%';
            
            cell.innerHTML = ''; cell.appendChild(input); input.focus(); input.select();

            const save = () => {
                window.inventory.updateProduct(productId, { [field]: parseInt(input.value) || 0 });
                cell.innerHTML = '‚è≥'; 
            };
            input.addEventListener('blur', save);
            input.addEventListener('keypress', (e) => { if (e.key === 'Enter') save(); });
        }

        function editComponentCell(cell, field) {
            if (currentRole === 'viewer') return;
            if (cell.querySelector('input')) return;
            const input = document.createElement('input');
            input.type = 'number'; input.value = window.inventory.components[field]; input.style.width = '100%';
            
            cell.innerHTML = ''; cell.appendChild(input); input.focus(); input.select();

            const save = () => {
                window.inventory.updateComponent(field, parseInt(input.value) || 0);
                cell.innerHTML = '‚è≥';
            };
            input.addEventListener('blur', save);
            input.addEventListener('keypress', (e) => { if (e.key === 'Enter') save(); });
        }

        // AKCJE UI DLA DOSTAW
        function confirmShipmentDateUI(id) {
            if (confirm('‚úì Potwierdziƒá datƒô dostawy?\nPrzeniesie to dostawƒô do tabeli potwierdzonych.')) {
                window.inventory.confirmShipment(id);
            }
        }

        function completeShipmentUI(id) {
            if (confirm('‚úì Zrealizowaƒá tƒô dostawƒô?\nOdjƒôte zostanie wszystko z kolumny "Gotowe do wysy≈Çki".')) {
                window.inventory.completeShipment(id);
            }
        }

        function completeRemainingShipmentUI(id) {
            if (confirm('‚úì Doko≈Ñczyƒá tƒô dostawƒô?\nBrakujƒÖce ilo≈õci zostanƒÖ odjƒôte z Twoich obecnych stan√≥w magazynowych.')) {
                window.inventory.completeRemainingShipment(id);
            }
        }

        function deleteShipment(id) { 
            if (currentRole === 'admin' && confirm('üóëÔ∏è Na pewno usunƒÖƒá tƒô dostawƒô z bazy?')) { 
                window.inventory.deleteShipment(id); 
            } 
        }

        function showAnglesDemand(id) {
            const shipment = window.inventory.shipments.find(s => s.id === id);
            if(!shipment) return;
            
            const p = shipment.products;
            const a22 = p[1] || 0;
            const a37 = (p[2] || 0) + (p[4] || 0);
            const a58 = (p[3] || 0) + (p[5] || 0);

            const content = `
                <div style="text-align: center;">
                    <p style="color: var(--text-light); margin-bottom: 1rem;">Zapotrzebowanie dla: <strong>${shipment.location}</strong></p>
                    <div style="display:flex; justify-content: space-around; background: var(--background); padding: 1.5rem; border-radius: 8px;">
                        <div><div style="font-size: 0.9rem; color: var(--primary-terracotta);">22¬∞</div><div style="font-size: 2rem; font-weight: bold;">${a22}</div></div>
                        <div><div style="font-size: 0.9rem; color: var(--primary-terracotta);">37¬∞</div><div style="font-size: 2rem; font-weight: bold;">${a37}</div></div>
                        <div><div style="font-size: 0.9rem; color: var(--primary-terracotta);">58¬∞</div><div style="font-size: 2rem; font-weight: bold;">${a58}</div></div>
                    </div>
                </div>
            `;
            showModal('üëÅÔ∏è Zapotrzebowanie KƒÖt√≥w', content);
        }

        function editShipmentDate(id) {
            if (currentRole === 'viewer') return;
            const shipment = window.inventory.shipments.find(s => s.id === id);
            if (!shipment) return;
            
            const form = `
                <div style="display: grid; gap: 1rem;">
                    <div class="form-group">
                        <label>Nowa data dla: <strong>${shipment.location}</strong></label>
                        <input type="date" id="edit_shipment_date" value="${shipment.date}">
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn-primary" onclick="saveShipmentDate(${id})">üíæ Zapisz</button>
                    </div>
                </div>
            `;
            showModal(`üìÖ Zmiana daty dostawy`, form);
        }

        async function saveShipmentDate(id) {
            const newDate = document.getElementById('edit_shipment_date').value;
            if (!newDate) return;
            await window.inventory.updateShipmentDateInDB(id, newDate);
            closeModal();
        }

        function deleteAdjustment(id) {
            if (currentRole === 'admin' && confirm('üóëÔ∏è UsunƒÖƒá ten wpis z regulacji?')) {
                window.inventory.deleteAdjustment(id);
            }
        }

        function printMissingPdf(id) {
            const shipment = window.inventory.shipments.find(s => s.id === id);
            if (!shipment || !shipment.partial_missing) return;
            
            const date = new Date().toLocaleDateString('pl-PL');
            
            let html = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>BrakujƒÖce Produkty - ${shipment.location}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 40px; color: #3E2723; }
                    h1 { color: #C4704B; border-bottom: 3px solid #D84C4C; padding-bottom: 10px; }
                    h2 { color: #A85A3A; margin-top: 30px; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th { background-color: #C4704B; color: white; padding: 10px; text-align: left; }
                    td { padding: 8px; border-bottom: 1px solid #D7CCC8; }
                    tr:nth-child(even) { background-color: #FBF7F2; }
                    .info-box { background-color: #FFF3E0; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #CD853F; }
                    .warning { color: #CD853F; font-weight: bold; }
                </style>
            </head>
            <body>
                <h1>‚ö†Ô∏è BRAKUJƒÑCE PRODUKTY - DOSTAWA NIEPE≈ÅNA</h1>
                <div class="info-box">
                    <h3>Informacje o dostawie</h3>
                    <p><strong>Lokalizacja:</strong> ${shipment.location}</p>
                    <p><strong>Firma OdbierajƒÖca:</strong> ${shipment.company || '-'}</p>
                    <p><strong>Data planowana:</strong> ${shipment.date}</p>
                    <p><strong>Data raportu:</strong> ${date}</p>
                </div>
                <h2>Lista brakujƒÖcych produkt√≥w</h2>
                <table>
                    <thead><tr><th>Produkt</th><th>SKU</th><th>Ilo≈õƒá brakujƒÖca</th></tr></thead>
                    <tbody>
            `;
            
            let totalMissing = 0;
            Object.entries(shipment.partial_missing).forEach(([productId, quantity]) => {
                const product = window.inventory.products.find(p => p.id === parseInt(productId));
                if (product) {
                    html += `<tr><td>${product.name}</td><td>${product.sku}</td><td class="warning">${quantity} szt</td></tr>`;
                    totalMissing += quantity;
                }
            });
            
            html += `
                    </tbody>
                </table>
                <div class="info-box">
                    <p><strong>Razem brakujƒÖcych opraw:</strong> <span class="warning">${totalMissing} szt</span></p>
                </div>
            </body>
            </html>
            `;
            
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); }, 250);
        }

        // OBS≈ÅUGA FORMULARZY
        document.getElementById('shipmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (currentRole === 'viewer') return;
            const formData = new FormData(this);
            const products = {
                1: parseInt(formData.get('p1')) || 0, 2: parseInt(formData.get('p2')) || 0,
                3: parseInt(formData.get('p3')) || 0, 4: parseInt(formData.get('p4')) || 0,
                5: parseInt(formData.get('p5')) || 0
            };
            window.inventory.addShipment({ 
                date: formData.get('date'), 
                location: formData.get('location'), 
                company: formData.get('company'),
                products: products 
            });
            this.reset(); 
        });

        const adjForm = document.getElementById('adjustmentForm');
        if(adjForm) {
            adjForm.addEventListener('submit', function(e) {
                e.preventDefault();
                if (currentRole === 'viewer') return;
                const formData = new FormData(this);
                window.inventory.addAdjustment(formData.get('adj_date'), formData.get('adj_location'));
                this.reset();
            });
        }

        document.getElementById('incomingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (currentRole === 'viewer') return;
            const formData = new FormData(this);
            const products = {
                1: parseInt(formData.get('p1')) || 0, 
                2: parseInt(formData.get('p2')) || 0,
                3: parseInt(formData.get('p3')) || 0
            };
            await window.inventory.addIncomingShipment(formData.get('supplier'), products);
            this.reset();
        });

        document.getElementById('productionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (currentRole === 'viewer') return;
            const formData = new FormData(this);
            const produced = {
                1: parseInt(formData.get('p1')) || 0, 2: parseInt(formData.get('p2')) || 0,
                3: parseInt(formData.get('p3')) || 0, 4: parseInt(formData.get('p4')) || 0,
                5: parseInt(formData.get('p5')) || 0
            };
            await window.inventory.registerProduction(produced);
            this.reset();
        });

        document.getElementById('componentsIncomingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (currentRole === 'viewer') return;
            const formData = new FormData(this);
            window.inventory.addComponentsShipment(formData.get('supplier'), {
                ps_raw: parseInt(formData.get('ps_raw')) || 0, clips_normal: parseInt(formData.get('clips_normal')) || 0, clips_pass: parseInt(formData.get('clips_pass')) || 0
            });
            this.reset();
        });

    </script>
</body>
</html>
